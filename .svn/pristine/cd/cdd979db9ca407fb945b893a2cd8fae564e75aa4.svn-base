<template>
  <div>
    <audio id="audio" controls="true" autoplay="true" style="display: none;"></audio>
    <el-alert style="width: max-content" :closable="false" v-show="alertShow"
              v-bind:title="alertTitle" show-icon
              type="warning"
              @close="hello">
    </el-alert>
  </div>
</template>


<script>

import {
  getToken, getAudioEnvironment
} from "@/api/basicData/safetyWarning/alarmTactics/alarmTactics";

/**文字播报组件*/
export default {
  name: "TextBroadcast",
  props: {
    message: {
      type: String,
      default: ''
    }
  },
  watch: {
    message(newVal, oldVal) {
      console.log("发生一次改变", "新值：" + newVal, "旧值：" + oldVal)
      // newVal是新值，oldVal是旧值
      if (!newVal) {
        return;
      }
      var data = newVal.split("$")[0];
      this.messagetext = data
      console.log(this.messageList);
      /**判断当前是否有正在播放,如果有直接插入，没有进入播放方法*/
      if (this.messageList.length == 0) {
        this.messageList.push(data)
        this.playVideo(data);
      } else {
        this.messageList.push(data)
      }
    }
  },
  data() {
    return {
      //  接收父组件传入的消息
      messagetext: "",
      messageList: [],
      isplay: true,
      baidutoken: "25.ac8017e7634d8d27704ddf1572862136.315360000.1981596844.282335-28000130",
      albbtoken: "",
      audiotype: 0,
      alertTitle: "",
      alertShow: false
    };
  },
  created() {
    this.getAudioEnvironment();
  },
  methods: {
    hello() {
      // alert('Hello World!');
    },
    getAudioEnvironment() {
      getAudioEnvironment().then(response => {
        this.audiotype = response.data.audioType;
        if (this.audiotype == 0) {
          this.getalbbToken();
        } else {
          this.baidutoken = response.data.baidutoken;

        }
      })
    },
    /**定时获取阿里巴巴token*/
    getalbbToken() {
      getToken().then(response => {
        setInterval(() => {
          getToken().then(response => {
            this.albbtoken = response.data
          })
        }, 60000 * 60)
        this.albbtoken = response.data
      })
    },
    /**播放语音*/
    playVideo() {
      this.alertShow = false;
      var that = this;
      const text = this.messageList[0];
      const audio = document.getElementById("audio");
      if (this.messageList.length > 0) {
        let url = "";
        if (this.audiotype == 0) {
          /**百度*/
          url = "http://tsn.baidu.com/text2audio?lan=zh&ctp=1&cuid=E4-54-E8-8D-5B-AE" +
            "&tok=" + this.baidutoken +
            "&per=0&vol=15&pit=6&tex=" +
            encodeURI(text);
        } else {
          /**阿里*/
          url = "https://nls-gateway-cn-shanghai.aliyuncs.com/stream/v1/tts?appkey=Np5zc6mDYxWverC4" +
            "&token=" + this.albbtoken +
            "&text=" + encodeURI(text) +
            "&format=wav&sample_rate=16000";
        }
        audio.src = url;
        this.alertShow = true;
        /**开始播放*/
        audio.play();
        this.alertTitle = text;
        /**关闭循环播放*/
        audio.loop = false;
        /**监听播放完毕后*/
        audio.addEventListener('ended', function () {
          /**清除数组中第一个值*/
          that.messageList.shift();
          that.playVideo();
        })
      }
    }
  }
};

</script>
<style>
</style>
