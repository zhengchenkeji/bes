package com.ruoyi.energyInfo.subitemConfig.controller;

import com.ruoyi.common.annotation.Log;
import com.ruoyi.common.core.controller.BaseController;
import com.ruoyi.common.core.domain.AjaxResult;
import com.ruoyi.common.core.domain.entity.SubitemConfig;
import com.ruoyi.common.core.page.TableDataInfo;
import com.ruoyi.common.enums.BusinessType;
import com.ruoyi.energyInfo.subitemConfig.domain.vo.SubitemBranchVo;
import com.ruoyi.energyInfo.subitemConfig.service.ISubitemBranchLinkService;
import com.ruoyi.energyInfo.subitemConfig.service.ISubitemConfigService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.apache.ibatis.annotations.Param;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * 分项拓扑配置Controller
 *
 * @author qindehua
 * @date 2022-09-20
 */
@RestController
@RequestMapping("/subitemConfig/config")
@Api(value = "分项拓扑配置", tags = {"分项拓扑配置"})
public class SubitemConfigController extends BaseController {
    @Autowired
    private ISubitemConfigService subitemConfigService;
    @Autowired
    private ISubitemBranchLinkService iSubitemBranchLinkService;

    /**
     * 查询分项拓扑配置列表
     */
    @PreAuthorize("@ss.hasPermi('subitemConfig:config:list')")
    @GetMapping("/list")
    public TableDataInfo list(SubitemConfig subitemConfig,
                              //搜索按钮标识 0:节点查询 1:搜索按钮查询
                              String code) {
        startPage();
        List<SubitemConfig> list = subitemConfigService.selectSubitemConfigListSun(subitemConfig, code);
        return getDataTable(list);
    }

    /**
     * 获取分项拓扑配置下拉树列表
     */
    @GetMapping("/treeSelect")
    @ApiOperation("获取分项拓扑配置下拉树列表")
    @PreAuthorize("@ss.hasPermi('householdConfig:config:list')")
    public AjaxResult treeSelect(SubitemConfig subitemConfig) {
        List<SubitemConfig> list = subitemConfigService.selectSubitemConfigList(subitemConfig);
        return AjaxResult.success(subitemConfigService.buildTreeSelect(list));
    }


//    /**
//     * 导出分项拓扑配置列表
//     */
//    @PreAuthorize("@ss.hasPermi('subitemConfig:config:export')")
//    @Log(title = "分项拓扑配置", businessType = BusinessType.EXPORT)
//    @PostMapping("/export")
//    public void export(HttpServletResponse response, SubitemConfig subitemConfig)
//    {
//        List<SubitemConfig> list = subitemConfigService.selectSubitemConfigList(subitemConfig);
//        ExcelUtil<SubitemConfig> util = new ExcelUtil<>(SubitemConfig.class);
//        util.exportExcel(response, list, "分项拓扑配置数据");
//    }

    /**
     * 获取分项拓扑配置详细信息
     */
    @PreAuthorize("@ss.hasPermi('subitemConfig:config:query')")
    @GetMapping(value = "/{subitemId}")
    public AjaxResult getInfo(@PathVariable("subitemId") String subitemId) {
        return AjaxResult.success(subitemConfigService.selectSubitemConfigBySubitemId(subitemId));
    }

    /**
     * 批量新增分项拓扑配置
     */
    @PreAuthorize("@ss.hasPermi('subitemConfig:config:add')")
    @Log(title = "分项拓扑配置", businessType = BusinessType.INSERT)
    @PostMapping("/addBatch")
    public AjaxResult addBatch(@RequestBody SubitemConfig subitemConfig) {
        return subitemConfigService.insertSubitemBatch(subitemConfig);
    }

    /**
     * 新增分项拓扑配置
     */
    @PreAuthorize("@ss.hasPermi('subitemConfig:config:add')")
    @Log(title = "分项拓扑配置", businessType = BusinessType.INSERT)
    @PostMapping
    public AjaxResult add(@Validated @RequestBody SubitemConfig subitemConfig) {
        return subitemConfigService.insertSubitemConfig(subitemConfig);
    }

    /**
     * 修改分项拓扑配置
     */
    @PreAuthorize("@ss.hasPermi('subitemConfig:config:edit')")
    @Log(title = "分项拓扑配置", businessType = BusinessType.UPDATE)
    @PutMapping
    public AjaxResult edit(@Validated @RequestBody SubitemConfig subitemConfig) {
        return subitemConfigService.updateSubitemConfig(subitemConfig);
    }

    /**
     * 删除分项拓扑配置
     */
    @PreAuthorize("@ss.hasPermi('subitemConfig:config:remove')")
    @Log(title = "分项拓扑配置", businessType = BusinessType.DELETE)
    @DeleteMapping("/{subitemIds}")
    public AjaxResult remove(@PathVariable String[] subitemIds) {
        return subitemConfigService.deleteSubitemConfigBySubitemIds(subitemIds);
    }

    /**
     * 包含支路 保存操作
     */
    @PreAuthorize("@ss.hasPermi('subitemConfig:config:edit')")
    @ApiOperation("包含支路 保存操作")
    @Log(title = "包含支路 保存操作", businessType = BusinessType.UPDATE)
    @PutMapping("/branch")
    public AjaxResult branch(@RequestBody SubitemBranchVo subitemBranchVo) {
        if (!subitemConfigService.saveAthenaBranchConfig(subitemBranchVo)) {
            return AjaxResult.error("包含支路失败！");
        } else {
            return AjaxResult.success("包含支路成功！");
        }
    }

    /**
     * 查询分户下支路列表
     */
    @ApiOperation("查询分户下支路列表")
    @PreAuthorize("@ss.hasPermi('subitemConfig:config:list')")
    @GetMapping("/listBranchById")
    public AjaxResult listBranchById(@Param("subitemId") String subitemId) {
        return AjaxResult.success(iSubitemBranchLinkService.selectAthenaBesBranchListById(subitemId));
    }
}
