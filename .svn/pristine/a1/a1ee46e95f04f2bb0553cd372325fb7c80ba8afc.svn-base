<template>
  <el-collapse-item title="组件联动" name="linkage" class="linkage-container">
    <el-form>
      <div v-for="(item, index) in linkage.data" :key="index" class="linkage-component">
        <div class="div-guanbi" v-if="index != 0" @click="deleteLinkageData(index)">
          <span class="iconfont icon-icon_guanbi"></span>
        </div>
        <!--<el-select v-model="item.id" placeholder="请选择联动组件" class="testtest">
          <el-option
            v-for="(component, i) in componentData"
            :key="component.id"
            :value="component.id"
            :label="component.label"
          >
            <div @mouseenter="onEnter(i)" @mouseout="onOut(i)">{{ component.label }}</div>
          </el-option>
        </el-select>
        <el-select v-model="item.event" placeholder="请选择监听事件">
          <el-option
            v-for="e in eventOptions"
            :key="e.value"
            :value="e.value"
            :label="e.label"
          ></el-option>
        </el-select>
        <p>事件触发时，当前组件要修改的属性</p>
        <div v-for="(e, i) in item.style" :key="i" class="attr-container">
          <el-select v-model="e.key" @change="e.value = ''">
            <el-option
              v-for="attr in Object.keys(curComponent.style)"
              :key="attr"
              :value="attr"
              :label="styleMap[attr]"
            ></el-option>
          </el-select>
          <el-color-picker v-if="isIncludesColor(e.key)" v-model="e.value" show-alpha></el-color-picker>
          <el-select v-else-if="selectKey.includes(e.key)" v-model="e.value">
            <el-option
              v-for="option in optionMap[e.key]"
              :key="option.value"
              :label="option.label"
              :value="option.value"
            ></el-option>
          </el-select>
          <el-input
            v-else
            v-model.number="e.value"
            type="number"
            placeholder="请输入"
          />
          <span class="iconfont icon-shanchu" @click="deleteData(item.style, i)"></span>
        </div>
        <el-button @click="addAttr(item.style)">添加属性</el-button>-->
        <p>点位配置</p>
        <div v-for="(e, i) in item.point" :key="i" class="attr-container">
          <el-form ref="form" label-width="40px">
            <el-form-item label="点位">
              <el-input
                ref="pointId"
                v-model="e.nickName"
                clearable
                size="small"
                type="string"
                placeholder="请输入"
                @focus="configPoint(e)"
              />
            </el-form-item>

            <el-form-item  v-if="booPointValue == true" label="值">
              <el-input
                v-model.number="e.value"
                type="number"
                placeholder="请输入"
              />
            </el-form-item>

<!--            <el-form-item label="单位">-->
<!--              <el-input-->
<!--                v-model="e.unit"-->
<!--                type="string"-->
<!--                placeholder="请输入"-->
<!--              />-->
<!--            </el-form-item>-->
<!--            <el-button v-if="onlyOneRow == false"  type="text" @click="addAttrPoint(item.point)">关联点位</el-button>-->
<!--            <span class="iconfont icon-shanchu" v-if="component == true" @click="deleteData(item.point, i)"></span>-->
          </el-form>
        </div>

<!--        <el-button v-if="onlyOneRow == false" @click="addAttrPoint(item.point)">关联点位</el-button>-->
      </div>
<!--      <el-button style="margin-bottom: 10px;" v-if="component == true"  @click="addComponent">添加组件</el-button>-->
      <!--<p>过渡时间（秒）</p>
      <el-input v-model="linkage.duration" class="input-duration" placeholder="请输入"></el-input>-->
    </el-form>

    <el-drawer
      title="设备树"
      :visible.sync="drawer"
      :direction="direction"
      :before-close="drawerBeforeClose"
      @opened="opened()"
      >
      <el-card>
        <div  style="max-height: 70.4vh;overflow-y: auto;">

          <el-tree
            class="filter-tree"
            show-checkbox
            :default-expand-all="false"
            :data="deviceTree"
            :props="deviceTreeProps"
            :expand-on-click-node="false"
            node-key="deviceTreeId"
            @check="choosePoint"
            :default-expanded-keys="defaultExpandedNode"
            ref="tree"

          />
        </div>
      </el-card>
    </el-drawer>
  </el-collapse-item>
</template>

<script>
  import {styleMap, optionMap, selectKey} from '@/utils/designer/attr'
  let id = 0;
  export default {
    computed: {
      linkage() {
        console.log(this.$store.state.curComponent.linkage)
        return this.$store.state.curComponent.linkage
      },
      onlyOneRow() {//是否只添加一个点位
        return this.$store.state.curComponent.onlyOneRow
      },
      booPointValue() {//是否配置点位值
        return this.$store.state.curComponent.booPointValue
      },
      component() {//组件名称
        let component = this.$store.state.curComponent.component;
        if (component == 'VText') {
          return false
        } else {
          return true
        }

      },
      componentData() {
        return this.$store.state.componentData
      },
      curComponent() {
        return this.$store.state.curComponent
      },

      deviceTree() {//设备树
        // debugger
        let aa = this.$store.state.deviceTreeData
        this.deviceTreeList = [];
        this.deviceTreeList.push(aa);
        return this.deviceTreeList
      },
    },
    data() {
      return {
        optionMap,
        selectKey,
        styleMap,
        eventOptions: [
          {label: '点击', value: 'v-click'},
          {label: '悬浮', value: 'v-hover'},
        ],
        oldOpacity: '',
        oldBackgroundColor: '',
        drawer: false,
        direction: 'rtl',

        deviceTreeList: undefined,
        deviceTreeProps: {
          children: "children",
          label: "sysName"
        },
        pointList: [],
        defaultExpandedNode: [0]
      }
    },
    methods: {

      //树节点选择事件
      choosePoint(data,e) {

        const that = this;
        if (this.onlyOneRow) {
          if (e.checkedKeys.length > 1){
            this.$modal.msgWarning("只能选择一个点位");
            this.$refs.tree.setCheckedKeys([e.checkedKeys[0]]);
            return;
          }
        }

        if (e.checkedKeys.length == 0) {
          this.linkage.data[0].point[0].id = ''
          return;
        }


        //判断点击的新增还是添加
        if (e.checkedKeys.includes(data.deviceTreeId)) {//如果有的话,则是选中
          if (e.checkedKeys.length == 1) {
            this.linkage.data[0].point[0].id = data.deviceTreeId
            this.linkage.data[0].point[0].sysName = data.redisSysName
            this.linkage.data[0].point[0].nickName = data.sysName
          } else{
            that.linkage.data[0].point.push({id: data.deviceTreeId,sysName: data.redisSysName,nickName: data.sysName, value: '',unit: ''})
          }

        } else {//取消选中
          that.linkage.data[0].point.some((item, i) => {
            if (item.id === data.deviceTreeId) {
              that.linkage.data[0].point.splice(i, 1)
            }
          })
        }

        if (that.linkage.data[0].point.length == 0) {
          that.linkage.data[0].point.push({id: '',sysName: '',nickName:'', value: '',unit: ''})
        }
        //首先判断选中的节点在点值配置中是否存在,不存在则添加

        //填充组件联动中点位配置的点位
        console.log(this.linkage.data[0].point)
        //  1 2 3                        1 2 3 4
        // e.checkedKeys.forEach((val,i) => {
        //   if (e.checkedKeys.length !=  that.linkage.data[0].point.length) {
        //
        //
        //
        //     that.linkage.data[0].point.push({id: val,value: '',unit: ''})
        //   } else {
        //     that.linkage.data[0].point[i].id = val
        //   }
        // })
      },

      onEnter(index) {
        this.oldOpacity = this.componentData[index].style.opacity
        this.oldBackgroundColor = this.componentData[index].style.backgroundColor
        this.componentData[index].style.opacity = '.3'
        this.componentData[index].style.backgroundColor = '#409EFF'
      },

      onOut(index) {
        this.componentData[index].style.opacity = this.oldOpacity
        this.componentData[index].style.backgroundColor = this.oldBackgroundColor
      },

      isIncludesColor(str) {
        return str.toLowerCase().includes('color')
      },

      //添加属性
      addAttr(style) {
        style.push({key: '', value: ''})
      },
      //关联点位
      addAttrPoint(point) {
        point.push({id: '',value: '',unit: ''})
      },

      //配置点位
      configPoint(e) {

        if (!this.drawer) {
          this.$refs.pointId.forEach(value => {
            value.blur();
          })
          this.drawer = true;
        }
      },

      opened() {
        let that = this;
        //首先展开选中的节点
        //显示已选中的节点
        this.linkage.data[0].point.forEach(value => {
          that.defaultExpandedNode.push(value.id);
          that.pointList.push(value.id)
        })
        this.$refs.tree.setCheckedKeys(that.pointList)
      },

      drawerBeforeClose(done) {
        this.defaultExpandedNode = [];
        this.pointList = [];
        this.$refs.tree.setCheckedKeys(this.pointList)
        done()
      },

      //添加组件
      addComponent() {
        this.linkage.data.push({
          id: '',
          event: '',
          style: [{key: '', value: ''}],
          point: [{id: '',sysName: '',nickName:'', value: '',unit: ''}]
        })
      },

      deleteData(style, index) {
        style.splice(index, 1)
      },

      deleteLinkageData(index) {
        this.linkage.data.splice(index, 1)
      },
    },
  }
</script>

<style lang="scss" scoped>
  .linkage-container {
    .linkage-component {
      margin: 5px 0;
      border: 1px solid #ddd;
      padding: 10px;
      position: relative;
      padding-top: 24px;

      .div-guanbi {
        cursor: pointer;
        position: absolute;
        right: 10px;
        top: 3px;
        color: #888;
        border: 1px solid #ddd;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;

        .iconfont {
          font-size: 12px;
        }
      }
    }

    .el-select {
      margin-bottom: 10px;
    }

    .attr-container {
      /*display: flex;*/
      align-items: center;
      justify-content: space-between;
      margin: 10px 0;

      .el-select {
        margin-bottom: 0;
      }

      & > div {
        width: 97px;
      }

      .icon-shanchu {
        cursor: pointer;
      }
    }
  }
</style>
