package com.ruoyi.energyCollection.collMethod.service.impl;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map;

import com.ruoyi.common.core.domain.AjaxResult;
import com.ruoyi.common.core.redis.RedisCache;
import com.ruoyi.common.utils.DateUtils;
import com.ruoyi.energyCollection.acquisitionParam.domain.ElectricParams;
import com.ruoyi.energyCollection.collMethod.domain.CollMethod;
import com.ruoyi.energyCollection.collMethod.domain.ElectricCollRlgl;
import com.ruoyi.energyCollection.collMethod.mapper.CollMethodMapper;
import com.ruoyi.energyCollection.collMethod.mapper.ElectricCollRlglMapper;
import com.ruoyi.energyCollection.collMethod.service.CollMethodService;
import com.zc.common.constant.RedisKeyConstants;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import javax.annotation.PostConstruct;
import javax.annotation.Resource;

import static com.ruoyi.common.core.domain.AjaxResult.error;
import static com.ruoyi.common.core.domain.AjaxResult.success;


/**
 * 采集方案Service业务层处理
 *
 * @author ruoyi
 * @date 2022-09-08
 */
@Service
public class CollMethodServiceImpl implements CollMethodService {
    @Autowired
    private CollMethodMapper collMethodMapper;
    @Autowired
    private ElectricCollRlglMapper electricCollRlglMapper;

    @Resource
    private RedisCache redisCache;

    @PostConstruct
    public void init() {
        /*
          添加数据到 redis 缓存
         */
        addCollMethodCache();
    }

    /**
     * 添加数据到 redis 缓存
     */
    public void addCollMethodCache() {
        // 获取全部采集参数定义列表数据
        List<CollMethod> collMethods = selectCollMethodList(null);

        // 清楚 redis 缓存数据
        redisCache.deleteObject(RedisKeyConstants.BES_BasicData_EnergyCollection_CollMethod);

        if (collMethods == null || collMethods.isEmpty()) {
            return;
        }

        // 添加 redis 缓存数据
        collMethods.forEach(val -> redisCache.setCacheMapValue(RedisKeyConstants.BES_BasicData_EnergyCollection_CollMethod, val.getCode(), val));
    }

    /**
     * 查询采集方案
     *
     * @param code 采集方案主键
     * @return 采集方案
     */
    @Override
    public CollMethod selectCollMethodByCode(String code) {
        return redisCache.getCacheMapValue(RedisKeyConstants.BES_BasicData_EnergyCollection_CollMethod, code);
    }

    /**
     * 查询采集方案列表
     *
     * @param collMethod 采集方案
     * @return 采集方案
     */
    @Override
    public List<CollMethod> selectCollMethodList(CollMethod collMethod) {
        return collMethodMapper.selectCollMethodList(collMethod);
    }

    /**
     * 新增采集方案
     *
     * @param collMethod 采集方案
     * @return 结果
     */
    @Override
    public AjaxResult insertCollMethod(CollMethod collMethod) {
        //获取缓存数据
        Map<String, CollMethod> CollMethodCacheMap = redisCache.getCacheMap(RedisKeyConstants.BES_BasicData_EnergyCollection_CollMethod);
        Collection<CollMethod> list = CollMethodCacheMap.values();
        for(CollMethod c : list){
            if(c.getName().equals(collMethod.getName())){
                return AjaxResult.error("名称重复,请检查");
            }
        }
//        //名称查重
//        List<CollMethod> collMethods = collMethodMapper.selectCollMethodCheck(collMethod);
//        if (collMethods.size() > 0) {
//            return AjaxResult.error("名称重复");
//        }
        String fCjfabh = null;
        if (list.size() > 0) {
            //获取最大编号
            int maxBh = getMaxBh(list);
            //定义 编号长度
            int bhLength = 4;
            //生成新的编号
            fCjfabh = String.format("%0" + bhLength + "d", maxBh + 1);
        } else {
            fCjfabh = "0001";
        }
        collMethod.setCode(fCjfabh);
        collMethod.setCreateTime(DateUtils.getNowDate());
        int isInsertCollMethod = collMethodMapper.insertCollMethod(collMethod);
        if (isInsertCollMethod == 0) {
            return AjaxResult.error("添加失败");
        }
        //添加到缓存
        redisCache.setCacheMapValue(RedisKeyConstants.BES_BasicData_EnergyCollection_CollMethod, collMethod.getCode(), collMethod);
        return AjaxResult.success("添加成功");
    }

    // 获取最大编号
    private int getMaxBh(Collection<CollMethod> list) {
        int maxnybh = 0;
        for (CollMethod c : list) {
            String sBh = c.getCode();
            int iBh = Integer.parseInt(sBh);
            if (maxnybh < iBh) {
                maxnybh = iBh;
            }
        }
        return maxnybh;
    }

    /**
     * 修改采集方案
     *
     * @param collMethod 采集方案
     * @return 结果
     */
    @Override
    public AjaxResult updateCollMethod(CollMethod collMethod) {
        //获取缓存数据
        Map<String, CollMethod> CollMethodCacheMap = redisCache.getCacheMap(RedisKeyConstants.BES_BasicData_EnergyCollection_CollMethod);
        Collection<CollMethod> list = CollMethodCacheMap.values();
        for(CollMethod c : list){
            if(c.getName().equals(collMethod.getName()) && !c.getCode().equals(collMethod.getCode())){
                return AjaxResult.error("名称重复,请检查");
            }
        }
//        //名称查重
//        List<CollMethod> collMethods = collMethodMapper.selectCollMethodCheck(collMethod);
//        if (collMethods.size() > 0) {
//            return AjaxResult.error("名称重复");
//        }
        collMethod.setUpdateTime(DateUtils.getNowDate());
        int isUpdateCollMethod = collMethodMapper.updateCollMethod(collMethod);
        if (isUpdateCollMethod == 0) {
            return AjaxResult.error("添加失败");
        }
        // 添加到缓存
        redisCache.setCacheMapValue(RedisKeyConstants.BES_BasicData_EnergyCollection_CollMethod, collMethod.getCode(), collMethod);
        return AjaxResult.success("添加成功");
    }

    /**
     * 批量删除采集方案
     *
     * @param codes 需要删除的采集方案主键
     * @return 结果
     */
    @Override
    public AjaxResult deleteCollMethodByCodes(String[] codes) {
        for (String str : codes) {
            //获取缓存采集参数定义数据
            CollMethod collMethod = redisCache.getCacheMapValue(RedisKeyConstants.BES_BasicData_EnergyCollection_CollMethod, str);
            //获取采集方案采集参数关联缓存
            Map<String, ElectricCollRlgl> ElectricCollRlglCacheMap = redisCache.getCacheMap(RedisKeyConstants.BES_BasicData_EnergyCollection_ElectricCollRlgl);
            Collection<ElectricCollRlgl> ElectricCollRlgls = ElectricCollRlglCacheMap.values();
            for (ElectricCollRlgl e : ElectricCollRlgls) {
                if (e.getCollCode().equals(collMethod.getCode())) {
                    return error("采集方案定义已被电表关联，请先删除相关信息");
                }
            }
        }
        boolean isDeleteCollMethodByCodes = collMethodMapper.deleteCollMethodByCodes(codes);
        if (isDeleteCollMethodByCodes) {
            // 删除当前记录缓存
            redisCache.delCacheMapValue(RedisKeyConstants.BES_BasicData_EnergyCollection_CollMethod, codes);
            return success("删除成功");
        }

        return error("删除失败");

    }

    /**
     * 删除采集方案信息
     *
     * @param code 采集方案主键
     * @return 结果
     */
    @Override
    public int deleteCollMethodByCode(String code) {
        int i = collMethodMapper.deleteCollMethodByCode(code);
        if (i > 0) {
            // 删除当前记录缓存
            redisCache.delCacheMapValue(RedisKeyConstants.BES_BasicData_EnergyCollection_CollMethod, code);
        }
        return i;
    }
}
