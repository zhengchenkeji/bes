<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zc.efounder.JEnterprise.mapper.baseData.ProductMapper">

    <resultMap type="Product" id="ProductResult">
        <result property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="code" column="code"/>
        <result property="state" column="state"/>
        <result property="categoryId" column="category_id"/>
        <result property="categoryName" column="category_name"/>
        <result property="iotType" column="iot_type"/>
        <result property="iotTypeName" column="iot_type_name"/>
        <result property="communicationProtocol" column="communication_protocol"/>
        <result property="communicationProtocolName" column="communication_protocol_name"/>
        <result property="messageProtocol" column="message_protocol"/>
        <result property="messageProtocolName" column="message_protocol_name"/>
        <result property="productDescribe" column="product_describe"/>
        <result property="createTime" column="create_time"/>
        <result property="createName" column="create_name"/>
        <result property="updateTime" column="update_time"/>
        <result property="updateName" column="update_name"/>
    </resultMap>

    <resultMap type="ProductItemData" id="ProductItemDataResult">
        <result property="id" column="id"/>
        <result property="sortNum" column="sort_num"/>
        <result property="productId" column="product_id"/>
        <result property="dataItemNum" column="data_item_num"/>
        <result property="dataItemMark" column="data_item_mark"/>
        <result property="name" column="name"/>
        <result property="dataType" column="data_type"/>
        <result property="dataName" column="data_name"/>
        <result property="dataUnit" column="data_unit"/>
        <result property="readType" column="read_type"/>
        <result property="preserveType" column="preserve_type"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
        <result property="createName" column="create_name"/>
        <result property="updateTime" column="update_time"/>
        <result property="updateName" column="update_name"/>
        <result property="dataValue" column="data_value"/>
        <result property="dataTime" column="data_time"/>
        <result property="functionCode" column="function_code"/>
        <result property="subscribeAddress" column="subscribe_address"/>
    </resultMap>

    <resultMap type="ProductFunction" id="ProductFunctionResult">
        <result property="id"    column="id"    />
        <result property="productId"    column="product_id"    />
        <result property="functionNum"    column="function_num"    />
        <result property="name"    column="name"    />
        <result property="type"    column="type"    />
        <result property="issuedType"    column="issued_type"    />
        <result property="communicationMode"    column="communication_mode"    />
        <result property="instruct"    column="instruct"    />
        <result property="dataLen"    column="data_len"    />
        <result property="dataItem"    column="data_item"    />
        <result property="itemValue"    column="item_value"    />
        <result property="remark"    column="remark"    />
        <result property="createTime"    column="create_time"    />
        <result property="createName"    column="create_name"    />
        <result property="updateTime"    column="update_time"    />
        <result property="updateName"    column="update_name"    />
    </resultMap>

    <sql id="selectProductVo">
        select id, name, code, state, category_id, iot_type, communication_protocol, message_protocol, product_describe, create_time, create_name, update_time, update_name from athena_bes_product
    </sql>

    <sql id="selectProductItemDataVo">
        select id, sort_num, product_id, data_item_num, data_item_mark, name, data_type, data_unit, read_type, preserve_type, remark, create_time, create_name, update_time, update_name, data_value, data_time,function_code,subscribe_address from athena_bes_product_item_data
    </sql>

    <sql id="selectProductFunctionVo">
        select id, product_id, function_num, name, type, issued_type, communication_mode, instruct, data_len, remark, create_time, create_name, update_time, update_name, data_item, item_value from athena_bes_product_function
    </sql>

    <!--查询产品定义列表-->
    <select id="selectAthenaBesProductList" parameterType="Product" resultMap="ProductResult">
        select t1.id, t1.name, t1.code, t1.state, t1.category_id, t2.category_name, t1.iot_type,
        (SELECT dict_label FROM sys_dict_data where dict_type = 'iot_type' and dict_value = t1.iot_type)
        iot_type_name,
        t1.communication_protocol,
        (SELECT dict_label FROM sys_dict_data where dict_type = 'communication_protocol_product' and dict_value = t1.communication_protocol)
        communication_protocol_name, t1.message_protocol,
        (SELECT agreement_name FROM athena_bes_agreement where id = t1.message_protocol)
        message_protocol_name,
        t1.product_describe,
        t1.create_time, t1.create_name, t1.update_time, t1.update_name from athena_bes_product t1
        left join athena_bes_category t2 on t1.category_id = t2.id
        <where>
            <if test="name != null  and name != ''">and t1.name like concat('%', #{name}, '%')</if>
            <if test="code != null  and code != ''">and t1.code = #{code}</if>
            <if test="state != null  and state != ''">and t1.state = #{state}</if>
            <if test="categoryId != null ">and t1.category_id = #{categoryId}</if>
            <if test="communicationProtocol != null  and communicationProtocol != ''">and t1.communication_protocol =
                #{communicationProtocol}
            </if>
            <if test="id != null  and id != ''"> and t1.id = #{id}</if>
        </where>
    </select>

    <!--查询所有产品-->
    <select id="selectAllProductList" resultType="map">
        select id value ,concat(name,' ',code) label from athena_bes_product
        where iot_type in
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="selectDictData" parameterType="String" resultType="map">
        SELECT dict_value id FROM `sys_dict_data` WHERE dict_type = #{type} AND dict_label = #{label}
    </select>

    <select id="selectDictDataOther" parameterType="String" resultType="map">
        SELECT dict_value id FROM `sys_dict_data` WHERE dict_type = #{type} AND dict_label != #{label}
    </select>

    <!--查询产品数据项列表-->
    <select id="selectAthenaBesProductItemDataList" parameterType="ProductItemData" resultMap="ProductItemDataResult">
        select t1.id, t1.sort_num, t1.product_id, t1.data_item_num, t1.data_item_mark, t1.name,
        t1.data_type, t2.dict_label data_name, t1.data_value, t1.data_time,
        t1.data_unit, t1.read_type,t1.function_code,
        t1.subscribe_address,
        t1.preserve_type, t1.remark, t1.create_time, t1.create_name, t1.update_time, t1.update_name from
        athena_bes_product_item_data t1
        left join sys_dict_data t2 on t1.data_type = t2.dict_code
        <where>
            <if test="productId != null  and productId != ''">t1.product_id = #{productId}</if>
            <if test="name != null  and name != ''">and t1.name like concat('%', #{name}, '%')</if>
            <if test="dataItemMark != null  and dataItemMark != ''">and t1.data_item_mark = #{dataItemMark}</if>
            <if test="dataItemNum != null  and dataItemNum != ''">and t1.data_item_num = #{dataItemNum}</if>
            <if test="id != null  and id != ''"> and t1.id = #{id}</if>
        </where>
    </select>

    <!--查询产品配置-功能定义列表-->
    <select id="selectAthenaBesProductFunctionList" parameterType="ProductFunction" resultMap="ProductFunctionResult">
        <include refid="selectProductFunctionVo"/>
        <where>
            <if test="productId != null "> and product_id = #{productId}</if>
            <if test="functionNum != null  and functionNum != ''"> and function_num = #{functionNum}</if>
            <if test="name != null  and name != ''"> and name like concat('%', #{name}, '%')</if>
            <if test="type != null  and type != ''"> and type = #{type}</if>
            <if test="id != null  and id != ''"> and id = #{id}</if>
        </where>
    </select>

    <!--查重产品定义-->
    <select id="selectAthenaBesProductListCheck" parameterType="Product" resultMap="ProductResult">
        <include refid="selectProductVo"/>
        <where>
            <if test="code != null  and code != ''">and code = #{code}</if>
            <if test="id != null  and id != ''">and id != #{id}</if>
        </where>
    </select>

    <!--查重产品数据项-->
    <select id="selectAthenaBesProductItemDataListCheck" parameterType="ProductItemData"
            resultMap="ProductItemDataResult">
        <include refid="selectProductItemDataVo"/>
        <where>
            (data_item_mark = #{dataItemMark} or data_item_num = #{dataItemNum} or sort_num = #{sortNum})
            <!--<if test="dataItemMark != null  and dataItemMark != ''">or </if>
            <if test="dataItemNum != null  and dataItemNum != ''"></if>
            <if test="sortNum != null  and sortNum != ''">or sort_num = #{sortNum}</if>-->
            <if test="id != null  and id != ''">and id != #{id}</if>
            <if test="productId != null "> and product_id = #{productId}</if>
        </where>
    </select>

    <!--查重产品功能-->
    <select id="selectAthenaBesProductFunctionListCheck" parameterType="ProductFunction"
            resultMap="ProductFunctionResult">
        <include refid="selectProductFunctionVo"/>
        <where>
            (name = #{name} or function_num = #{functionNum})
            <if test="id != null  and id != ''">and id != #{id}</if>
        </where>
    </select>

    <!--查询产品配置-功能定义-->
    <select id="selectAthenaBesProductFunctionById" parameterType="Long" resultMap="ProductFunctionResult">
        <include refid="selectProductFunctionVo"/>
        where id = #{id}
    </select>

    <!--查询产品定义-->
    <select id="selectAthenaBesProductById" parameterType="Long" resultMap="ProductResult">
        <include refid="selectProductVo"/>
        where id = #{id}
    </select>

    <!--查询产品数据项-->
    <select id="selectAthenaBesProductItemDataById" parameterType="Long" resultMap="ProductItemDataResult">
        <include refid="selectProductItemDataVo"/>
        where id = #{id}
    </select>

    <!--添加产品定义-->
    <insert id="insertAthenaBesProduct" parameterType="Product" useGeneratedKeys="true" keyProperty="id">
        insert into athena_bes_product
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="name != null">name,</if>
            <if test="code != null">code,</if>
            <if test="state != null">state,</if>
            <if test="categoryId != null">category_id,</if>
            <if test="iotType != null">iot_type,</if>
            <if test="communicationProtocol != null">communication_protocol,</if>
            <if test="messageProtocol != null">message_protocol,</if>
            <if test="productDescribe != null">product_describe,</if>
            <if test="createTime != null">create_time,</if>
            <if test="createName != null">create_name,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="updateName != null">update_name,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="name != null">#{name},</if>
            <if test="code != null">#{code},</if>
            <if test="state != null">#{state},</if>
            <if test="categoryId != null">#{categoryId},</if>
            <if test="iotType != null">#{iotType},</if>
            <if test="communicationProtocol != null">#{communicationProtocol},</if>
            <if test="messageProtocol != null">#{messageProtocol},</if>
            <if test="productDescribe != null">#{productDescribe},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="createName != null">#{createName},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="updateName != null">#{updateName},</if>
        </trim>
    </insert>

    <!--添加产品数据项-->
    <insert id="insertAthenaBesProductItemData" parameterType="ProductItemData" useGeneratedKeys="true"
            keyProperty="id">
        insert into athena_bes_product_item_data
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="sortNum != null">sort_num,</if>
            <if test="productId != null">product_id,</if>
            <if test="dataItemNum != null">data_item_num,</if>
            <if test="dataItemMark != null">data_item_mark,</if>
            <if test="name != null">name,</if>
            <if test="dataType != null">data_type,</if>
            <if test="dataUnit != null">data_unit,</if>
            <if test="readType != null">read_type,</if>
            <if test="preserveType != null">preserve_type,</if>
            <if test="remark != null">remark,</if>
            <if test="createTime != null">create_time,</if>
            <if test="createName != null">create_name,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="updateName != null">update_name,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="dataValue != null">data_value,</if>
            <if test="dataTime != null">data_time,</if>
            <if test="functionCode != null">function_code,</if>
            <if test="subscribeAddress != null">subscribe_address,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="sortNum != null">#{sortNum},</if>
            <if test="productId != null">#{productId},</if>
            <if test="dataItemNum != null">#{dataItemNum},</if>
            <if test="dataItemMark != null">#{dataItemMark},</if>
            <if test="name != null">#{name},</if>
            <if test="dataType != null">#{dataType},</if>
            <if test="dataUnit != null">#{dataUnit},</if>
            <if test="readType != null">#{readType},</if>
            <if test="preserveType != null">#{preserveType},</if>
            <if test="remark != null">#{remark},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="createName != null">#{createName},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="updateName != null">#{updateName},</if>
            <if test="dataValue != null">#{dataValue},</if>
            <if test="dataTime != null">#{dataTime},</if>
            <if test="functionCode != null">#{functionCode},</if>
            <if test="subscribeAddress != null">#{subscribeAddress},</if>
        </trim>
    </insert>

    <!--新增产品配置-功能定义-->
    <insert id="insertAthenaBesProductFunction" parameterType="ProductFunction" useGeneratedKeys="true" keyProperty="id">
        insert into athena_bes_product_function
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="productId != null">product_id,</if>
            <if test="functionNum != null">function_num,</if>
            <if test="name != null">name,</if>
            <if test="type != null">type,</if>
            <if test="issuedType != null">issued_type,</if>
            <if test="communicationMode != null">communication_mode,</if>
            <if test="instruct != null">instruct,</if>
            <if test="dataLen != null">data_len,</if>
            <if test="dataItem != null">data_item,</if>
            <if test="itemValue != null">item_value,</if>
            <if test="remark != null">remark,</if>
            <if test="createTime != null">create_time,</if>
            <if test="createName != null">create_name,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="updateName != null">update_name,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="productId != null">#{productId},</if>
            <if test="functionNum != null">#{functionNum},</if>
            <if test="name != null">#{name},</if>
            <if test="type != null">#{type},</if>
            <if test="issuedType != null">#{issuedType},</if>
            <if test="communicationMode != null">#{communicationMode},</if>
            <if test="instruct != null">#{instruct},</if>
            <if test="dataLen != null">#{dataLen},</if>
            <if test="dataItem != null">#{dataItem},</if>
            <if test="itemValue != null">#{itemValue},</if>
            <if test="remark != null">#{remark},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="createName != null">#{createName},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="updateName != null">#{updateName},</if>
        </trim>
    </insert>

    <!--修改产品定义-->
    <update id="updateAthenaBesProduct" parameterType="Product">
        update athena_bes_product
        <trim prefix="SET" suffixOverrides=",">
            <if test="name != null">name = #{name},</if>
            <if test="code != null">code = #{code},</if>
            <if test="state != null">state = #{state},</if>
            <if test="categoryId != null">category_id = #{categoryId},</if>
            <if test="iotType != null">iot_type = #{iotType},</if>
            <if test="communicationProtocol != null">communication_protocol = #{communicationProtocol},</if>
            message_protocol = #{messageProtocol},
            <if test="productDescribe != null">product_describe = #{productDescribe},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="createName != null">create_name = #{createName},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="updateName != null">update_name = #{updateName},</if>
        </trim>
        where id = #{id}
    </update>

    <!--修改产品数据项-->
    <update id="updateAthenaBesProductItemData" parameterType="ProductItemData">
        update athena_bes_product_item_data
        <trim prefix="SET" suffixOverrides=",">
            <if test="sortNum != null">sort_num = #{sortNum},</if>
            <if test="productId != null">product_id = #{productId},</if>
            <if test="dataItemNum != null">data_item_num = #{dataItemNum},</if>
            <if test="dataItemMark != null">data_item_mark = #{dataItemMark},</if>
            <if test="name != null">name = #{name},</if>
            <if test="dataType != null">data_type = #{dataType},</if>
            <if test="dataUnit != null">data_unit = #{dataUnit},</if>
            <if test="readType != null">read_type = #{readType},</if>
            <if test="preserveType != null">preserve_type = #{preserveType},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="createName != null">create_name = #{createName},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="updateName != null">update_name = #{updateName},</if>
            <if test="dataValue != null">data_value = #{dataValue},</if>
            <if test="dataTime != null">data_time = #{dataTime},</if>
            <if test="functionCode != null">function_code = #{functionCode},</if>
            <if test="subscribeAddress != null">subscribe_address = #{subscribeAddress},</if>
        </trim>
        where id = #{id}
    </update>

    <!--修改产品配置-功能定义-->
    <update id="updateAthenaBesProductFunction" parameterType="ProductFunction">
        update athena_bes_product_function
        <trim prefix="SET" suffixOverrides=",">
            <if test="productId != null">product_id = #{productId},</if>
            <if test="functionNum != null">function_num = #{functionNum},</if>
            <if test="name != null">name = #{name},</if>
            <if test="type != null">type = #{type},</if>
            <if test="issuedType != null">issued_type = #{issuedType},</if>
            <if test="communicationMode != null">communication_mode = #{communicationMode},</if>
            <if test="instruct != null">instruct = #{instruct},</if>
            <if test="dataLen != null">data_len = #{dataLen},</if>
            <if test="dataItem != null">data_item = #{dataItem},</if>
            <if test="itemValue != null">item_value = #{itemValue},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="createName != null">create_name = #{createName},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="updateName != null">update_name = #{updateName},</if>
        </trim>
        where id = #{id}
    </update>

    <!--删除产品定义-->
    <delete id="deleteAthenaBesProductById" parameterType="Long">
        delete from athena_bes_product where id = #{id}
    </delete>

    <!--批量删除产品定义-->
    <delete id="deleteAthenaBesProductByIds" parameterType="String">
        delete from athena_bes_product where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!--删除产品数据项-->
    <delete id="deleteAthenaBesProductItemDataById" parameterType="Long">
        delete from athena_bes_product_item_data where id = #{id}
    </delete>

    <!--批量删除产品数据项-->
    <delete id="deleteAthenaBesProductItemDataByIds" parameterType="String">
        delete from athena_bes_product_item_data where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!--删除产品配置-功能定义-->
    <delete id="deleteAthenaBesProductFunctionById" parameterType="Long">
        delete from athena_bes_product_function where id = #{id}
    </delete>

    <!--批量删除产品配置-功能定义-->
    <delete id="deleteAthenaBesProductFunctionByIds" parameterType="String">
        delete from athena_bes_product_function where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!--查询数据类型list-->
    <select id="getAllIotTypeList" resultType="map">
        SELECT dict_code value,dict_label label FROM sys_dict_data
        <where>
            <if test="dictType != null">
                and dict_type = #{dictType}
            </if>
            <if test="id != null and id != ''">
                and dict_value = #{id}
            </if>
        </where>
    </select>

    <!--查询物联类型/消息协议list-->
    <select id="getAllMessageIdList" resultType="map">
        SELECT dict_value value,dict_label label FROM sys_dict_data
        <where>
            <if test="dictType != null">
                and dict_type = #{dictType}
            </if>
            <if test="id != null and id != ''">
                and dict_value = #{id}
            </if>
        </where>
    </select>

</mapper>
