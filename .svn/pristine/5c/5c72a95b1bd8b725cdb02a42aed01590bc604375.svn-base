<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zc.efounder.JEnterprise.mapper.electricPowerTranscription.ExtremeValueReportMapper">

    <select id="queryMeterList" parameterType="ExtremeValueReport" resultType="String">
        SELECT c.sys_name code FROM athena_bes_branch_meter_link a
	    LEFT JOIN athena_bes_electric_meter b ON a.meter_id = b.meter_id
	    LEFT JOIN athena_bes_device_tree c ON b.device_tree_id= c.device_tree_id
        WHERE branch_id = #{branchId}
    </select>

    <select id="queryDayChartsData" parameterType="ExtremeValueReport" resultType="Map">
        <if test="dataType != null and dataType == '2'.toString()">
            SELECT IFNULL(a.F_DBSYS_NAME,'') code,IFNULL(c.alias,'') name,
            IFNULL(round( MAX( a.F_DATA ), 2 ),'') maxInfo,
            IFNULL(( SELECT DATE_FORMAT( F_CJSJ, '%Y-%m-%d %H:%i' ) FROM athena_bes_original_data WHERE F_DATA = MAX(
            a.F_DATA ) AND DATE_FORMAT( F_CJSJ, '%Y-%m' ) = DATE_FORMAT( a.F_CJSJ, '%Y-%m' ) LIMIT 1 ),'') maxTime,
            IFNULL(round( MIN( a.F_DATA ), 2 ),'') minInfo,
            IFNULL(( SELECT DATE_FORMAT( F_CJSJ, '%Y-%m-%d %H:%i' ) FROM athena_bes_original_data WHERE F_DATA = MIN(
            a.F_DATA ) AND DATE_FORMAT( F_CJSJ, '%Y-%m' ) = DATE_FORMAT( a.F_CJSJ, '%Y-%m' ) LIMIT 1 ),'') minTime,
            IFNULL(round( AVG( a.F_DATA ), 2 ),'') avgInfo
            FROM athena_bes_original_data a LEFT JOIN athena_bes_device_tree b ON a.F_DBSYS_NAME = b.sys_name LEFT JOIN
            athena_bes_electric_meter c ON b.device_tree_id = c.device_tree_id
            <where>
                DATE_FORMAT( F_CJSJ, '%Y-%m' ) = #{monDate} AND F_DNBH = #{paramsId}
                <if test="meterList != null and meterList.size() > 0">
                    AND a.F_DBSYS_NAME in
                    <foreach item="code" collection="meterList" open="(" separator="," close=")">
                        #{code}
                    </foreach>
                </if>
            </where>
            GROUP BY a.F_DBSYS_NAME
        </if>
        <if test="dataType != null and dataType == '1'.toString()">
            SELECT IFNULL(a.F_DBSYS_NAME,'') code,IFNULL(c.alias,'') name,
            IFNULL(round( MAX( a.F_DATA ), 2 ),'') maxInfo,
            IFNULL(( SELECT DATE_FORMAT( F_CJSJ, '%Y-%m-%d %H:%i' ) FROM athena_bes_original_data WHERE F_DATA = MAX(
            a.F_DATA ) AND DATE_FORMAT( F_CJSJ, '%Y-%m-%d' ) = DATE_FORMAT( a.F_CJSJ, '%Y-%m-%d' ) LIMIT 1 ),'')
            maxTime,
            IFNULL(round( MIN( a.F_DATA ), 2 ),'') minInfo,
            IFNULL(( SELECT DATE_FORMAT( F_CJSJ, '%Y-%m-%d %H:%i' ) FROM athena_bes_original_data WHERE F_DATA = MIN(
            a.F_DATA ) AND DATE_FORMAT( F_CJSJ, '%Y-%m-%d' ) = DATE_FORMAT( a.F_CJSJ, '%Y-%m-%d' ) LIMIT 1 ),'')
            minTime,
            IFNULL(round( AVG( a.F_DATA ), 2 ),'') avgInfo
            FROM athena_bes_original_data a LEFT JOIN athena_bes_device_tree b ON a.F_DBSYS_NAME = b.sys_name LEFT JOIN
            athena_bes_electric_meter c ON b.device_tree_id = c.device_tree_id
            <where>
                DATE_FORMAT( F_CJSJ, '%Y-%m-%d' ) = #{dayDate} AND F_DNBH = #{paramsId}
                <if test="meterList != null and meterList.size() > 0">
                    AND a.F_DBSYS_NAME in
                    <foreach item="code" collection="meterList" open="(" separator="," close=")">
                        #{code}
                    </foreach>
                </if>
            </where>
            GROUP BY a.F_DBSYS_NAME
        </if>
    </select>

</mapper>